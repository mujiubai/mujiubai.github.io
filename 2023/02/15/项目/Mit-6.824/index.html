<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Mit-6.824, w">
    <meta name="description" content="Lab1：MapReduceMapReduce框架：

任务描述实现分布式MapReduce，一个coordinator，一个worker（启动多个），在这次实验都在一个机器上运行。worker通过rpc和coordinator交互。wor">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Mit-6.824 | w</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">w</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">

      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/categories/C/">
          
          <span>C++</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/LeetCode/">
          
          <span>LeetCode</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">
          
          <span>计算机基础知识</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/%E9%A1%B9%E7%9B%AE/">
          
          <span>项目</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">w</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-bookmark"></i>
			
			分类
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/categories/C/ " style="margin-left:75px">
				  
		          <span>C++</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/LeetCode/ " style="margin-left:75px">
				  
		          <span>LeetCode</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/ " style="margin-left:75px">
				  
		          <span>计算机基础知识</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/%E9%A1%B9%E7%9B%AE/ " style="margin-left:75px">
				  
		          <span>项目</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/13.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Mit-6.824</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/">
                                <span class="chip bg-color">分布式存储</span>
                            </a>
                        
                            <a href="/tags/Go/">
                                <span class="chip bg-color">Go</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E9%A1%B9%E7%9B%AE/" class="post-category">
                                项目
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-02-15
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-06-20
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    28 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Lab1：MapReduce"><a href="#Lab1：MapReduce" class="headerlink" title="Lab1：MapReduce"></a>Lab1：MapReduce</h1><p>MapReduce框架：</p>
<p><img src="https://cdn.jsdelivr.net/gh/mujiubai/piclib@main/picgo/image-20230620115253482.png"></p>
<h2 id="任务描述"><a href="#任务描述" class="headerlink" title="任务描述"></a><strong>任务描述</strong></h2><p>实现分布式MapReduce，一个coordinator，一个worker（启动多个），在这次实验都在一个机器上运行。worker通过rpc和coordinator交互。worker请求任务,进行运算,写出结果到文件。coordinator需要关心worker的任务是否完成，在超时情况下将任务重新分配给别的worker。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><ul>
<li>系统的输入是一堆文件，每个文件对应一个 Map 任务。任务由 Worker 向 Coordinator 请求，由 Coordinator 向下分发。</li>
<li>在分发 Map 任务时，Coordinator 同时会传递 Reduce 的任务数量（NReduce）给 Worker。</li>
<li>每个 Map Worker 会生成 NReduce 个中间文件，将不同的 Key 哈希到不同文件里。文件命名为mr-n-m，其中n为文件序号，m为reduce序号</li>
<li>每个Reduce Worker x会读取所有mr-*-x文件，然后使用map函数对其处理，然后将其输出</li>
<li>使用临时文件方法来避免crash发生</li>
<li>使用互斥访问来避免并行执行时异常发生</li>
</ul>
<h3 id="任务队列"><a href="#任务队列" class="headerlink" title="任务队列"></a>任务队列</h3><p>使用一个结构体来描述任务信息：</p>
<pre class="line-numbers language-none"><code class="language-none">type TaskInfo struct &#123;
	TaskType  string &#x2F;&#x2F;分为四种类型：Map、Reduce、Wait(等待所有Map执行完)、None(无任务，结束)
	FilePath  string
	NReduce   int
	Ridx      int &#x2F;&#x2F;reduce 任务idx
	FileN     int &#x2F;&#x2F;总文件数
	FileIdx   int &#x2F;&#x2F;当前任务文件序列号
	StartTime int64
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>为了简便，没有分开map任务信息和reduce信息。各字段说明如下：</p>
<ul>
<li>TaskType：分为Map、Reduce、Wait(等待所有Map或Reduce任务执行完)、None(无任务，结束)</li>
<li>FilePath：Map任务执行时的输入文件，Reduce任务忽略此字段</li>
<li>NReduce：Map将每个单词置于不同文件中，放置位置是使用单词的哈希函数除NReduce求得（这就使得将所有单词分离到不同Reduce任务中）。</li>
<li>Ridx：reduce 任务idx，即用于识别属于该reduce任务的文件</li>
<li>FileN：在Map任务重，每个输入文件都会输出NReduce个临时文件，因此在Reduce任务中需要知道所有文件数量才能读取完临时文件</li>
<li>FileIdx：当前任务文件序列号，用于Map任务时输出临时文件的文件名</li>
<li>StartTime：任务开始时间，主要用于判断当前任务是否已经超时，如果超时则使用重新分配此任务</li>
</ul>
<p>在实现的队列结构中，使用一个哈希表和mutex：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> TaskQue <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	mQue  <span class="token keyword">map</span><span class="token punctuation">[</span>TaskInfo<span class="token punctuation">]</span><span class="token builtin">int</span>
	mutex sync<span class="token punctuation">.</span>Mutex
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外实现了pop、insert、getLen、empty、delete函数，主要是使用mutex来避免多线程访问时出现异常。</p>
<h3 id="Coordinator"><a href="#Coordinator" class="headerlink" title="Coordinator"></a><em>Coordinator</em></h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Coordinator <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// Your definitions here.</span>
	mapDo       TaskQue
	mapDoing    TaskQue
	reduceDo    TaskQue
	reduceDoing TaskQue
	nReduce     <span class="token builtin">int</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>coordinator用于协调worker，其主要由四个队列组成：</p>
<ul>
<li>mapDo：需要执行map任务的队列</li>
<li>mapDoing：正在执行map任务的队列</li>
<li>reduceDo：需要执行reduce任务的队列</li>
<li>reduceDoing：正在执行reduce任务的队列</li>
</ul>
<p>主要实现了两个RPC函数：</p>
<ul>
<li><p>请求任务函数：GetTask，主要用于判断是分配Map、Reduce还是等待或结束程序，另外为了简便，还是此函数中判断了是否有超时任务，如果有则将其重新分配</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">GetTask</span><span class="token punctuation">(</span>args <span class="token builtin">int</span><span class="token punctuation">,</span> reply <span class="token operator">*</span>TaskInfo<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>

	<span class="token comment">//map和reduce正在执行的任务超过10秒，则重新执行</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>mapDoing<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> key<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>mapDoing<span class="token punctuation">.</span>mQue <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>key<span class="token punctuation">.</span>StartTime <span class="token operator">></span> <span class="token number">10</span> <span class="token punctuation">&#123;</span>
				tmp <span class="token operator">:=</span> c<span class="token punctuation">.</span>mapDoing<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				c<span class="token punctuation">.</span>mapDo<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>reduceDoing<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> key<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>reduceDoing<span class="token punctuation">.</span>mQue <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>key<span class="token punctuation">.</span>StartTime <span class="token operator">></span> <span class="token number">10</span> <span class="token punctuation">&#123;</span>
				tmp <span class="token operator">:=</span> c<span class="token punctuation">.</span>reduceDoing<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				c<span class="token punctuation">.</span>reduceDo<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>mapDo<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token operator">*</span>reply <span class="token operator">=</span> c<span class="token punctuation">.</span>mapDo<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>mapDoing<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>mapDoing<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token operator">*</span>reply <span class="token operator">=</span> TaskInfo<span class="token punctuation">&#123;</span><span class="token string">"Wait"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>reduceDo<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token operator">*</span>reply <span class="token operator">=</span> c<span class="token punctuation">.</span>reduceDo<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>reduceDoing<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token operator">*</span>reply <span class="token operator">=</span> TaskInfo<span class="token punctuation">&#123;</span><span class="token string">"None"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token operator">*</span>reply <span class="token operator">=</span> TaskInfo<span class="token punctuation">&#123;</span><span class="token string">"Wait"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>任务完成报告函数：FinReport，主要是判断完成的Map还是Reduce任务，并将其从相应的doing队列中移除</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">FinReport</span><span class="token punctuation">(</span>args TaskInfo<span class="token punctuation">,</span> reply <span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>TaskType <span class="token operator">==</span> <span class="token string">"Map"</span> <span class="token punctuation">&#123;</span>
		c<span class="token punctuation">.</span>mapDoing<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> args<span class="token punctuation">.</span>TaskType <span class="token operator">==</span> <span class="token string">"Reduce"</span> <span class="token punctuation">&#123;</span>
		c<span class="token punctuation">.</span>reduceDoing<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="worker"><a href="#worker" class="headerlink" title="worker"></a>worker</h3><p>实现请求任务和报告任务完成函数的远程调用，根据请求任务的结果判断是执行Map任务还是Reduce任务或等待或结束进程。</p>
<p><strong>Map任务执行实现</strong>：根据taskinfo中的信息读取输入文件，使用mapf函数得到中间值，然后根据每个单词的不同哈希值将其存储到不同文件中（输出时使用时json进行编码）</p>
<ul>
<li>为了通过crash test，每个单词输出到临时文件，当所有单词输出完成后才将临时文件重命名。即使在重命名时程序崩溃，由于输出文件是使用的覆盖，因此也不会出现异常。</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">doMap</span><span class="token punctuation">(</span>task <span class="token operator">*</span>TaskInfo<span class="token punctuation">,</span> mapf <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>KeyValue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// fmt.Printf("Map id:%v, map time:%v\n", task.FileIdx, task.StartTime)</span>
	intermediate <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>KeyValue<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	filename <span class="token operator">:=</span> task<span class="token punctuation">.</span>FilePath
	file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"cannot open %v"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	content<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"cannot read %v"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	kva <span class="token operator">:=</span> <span class="token function">mapf</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>
	intermediate <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>intermediate<span class="token punctuation">,</span> kva<span class="token operator">...</span><span class="token punctuation">)</span>

	<span class="token comment">//生成临时文件，避免程序崩溃时导致错误发生</span>
	nReduce <span class="token operator">:=</span> task<span class="token punctuation">.</span>NReduce
	outFiles <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">,</span> nReduce<span class="token punctuation">)</span>
	fileEncs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>json<span class="token punctuation">.</span>Encoder<span class="token punctuation">,</span> nReduce<span class="token punctuation">)</span>
	<span class="token keyword">for</span> outIdx <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> outIdx <span class="token operator">&lt;</span> nReduce<span class="token punctuation">;</span> outIdx<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		outFiles<span class="token punctuation">[</span>outIdx<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">TempFile</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"mr-tmp-*"</span><span class="token punctuation">)</span>
		fileEncs<span class="token punctuation">[</span>outIdx<span class="token punctuation">]</span> <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>outFiles<span class="token punctuation">[</span>outIdx<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> kv <span class="token operator">:=</span> <span class="token keyword">range</span> intermediate <span class="token punctuation">&#123;</span>
		hashIdx <span class="token operator">:=</span> <span class="token function">ihash</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>Key<span class="token punctuation">)</span> <span class="token operator">%</span> nReduce
		enc <span class="token operator">:=</span> fileEncs<span class="token punctuation">[</span>hashIdx<span class="token punctuation">]</span>
		err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kv<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"kv encode failed! Error: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> outIdx<span class="token punctuation">,</span> file <span class="token operator">:=</span> <span class="token keyword">range</span> outFiles <span class="token punctuation">&#123;</span>
		newName <span class="token operator">:=</span> <span class="token string">"mr-"</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>FileIdx<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>outIdx<span class="token punctuation">)</span>
		oldName <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		os<span class="token punctuation">.</span><span class="token function">Rename</span><span class="token punctuation">(</span>oldName<span class="token punctuation">,</span> newName<span class="token punctuation">)</span>
		file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">CallFinReport</span><span class="token punctuation">(</span><span class="token operator">*</span>task<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Reduce任务执行实现</strong>：从所有属于该reduce任务的文件中读取数据，然后使用sort进行排序，再使用reducef函数输出。同理，为了通过crash test，使用临时文件进行输出。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">doReduce</span><span class="token punctuation">(</span>task <span class="token operator">*</span>TaskInfo<span class="token punctuation">,</span> reducef <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	intermediate <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>KeyValue<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> idx <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">&lt;</span> task<span class="token punctuation">.</span>FileN<span class="token punctuation">;</span> idx<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		fileName <span class="token operator">:=</span> <span class="token string">"mr-"</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>Ridx<span class="token punctuation">)</span>
		file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"file:%v read failed!\n"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		dec <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> kv KeyValue
			<span class="token keyword">if</span> err <span class="token operator">:=</span> dec<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kv<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
			intermediate <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>intermediate<span class="token punctuation">,</span> kv<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span><span class="token function">ByKey</span><span class="token punctuation">(</span>intermediate<span class="token punctuation">)</span><span class="token punctuation">)</span>

	outFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">TempFile</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"mr-tmp-out-*"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"create temp file failed!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	i <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>intermediate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		j <span class="token operator">:=</span> i <span class="token operator">+</span> <span class="token number">1</span>
		<span class="token keyword">for</span> j <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>intermediate<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> intermediate<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>Key <span class="token operator">==</span> intermediate<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Key <span class="token punctuation">&#123;</span>
			j<span class="token operator">++</span>
		<span class="token punctuation">&#125;</span>
		values <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
		<span class="token keyword">for</span> k <span class="token operator">:=</span> i<span class="token punctuation">;</span> k <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> k<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			values <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> intermediate<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		output <span class="token operator">:=</span> <span class="token function">reducef</span><span class="token punctuation">(</span>intermediate<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Key<span class="token punctuation">,</span> values<span class="token punctuation">)</span>
		<span class="token comment">// this is the correct format for each line of Reduce output.</span>
		fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">"%v %v\n"</span><span class="token punctuation">,</span> intermediate<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Key<span class="token punctuation">,</span> output<span class="token punctuation">)</span>
		i <span class="token operator">=</span> j
	<span class="token punctuation">&#125;</span>

	newName <span class="token operator">:=</span> <span class="token string">"mr-out-"</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>Ridx<span class="token punctuation">)</span>
	os<span class="token punctuation">.</span><span class="token function">Rename</span><span class="token punctuation">(</span>outFile<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newName<span class="token punctuation">)</span>
	outFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">CallFinReport</span><span class="token punctuation">(</span><span class="token operator">*</span>task<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>early exit test不通过：</p>
<ul>
<li>此测试是为了测试在任务未完成情况下，是否有worker或master退出</li>
<li>在实现中，请求任务时会检测所有任务是否完成，如果为完成则wait，否则退出。</li>
</ul>
</blockquote>
<h1 id="Lab2：Raft"><a href="#Lab2：Raft" class="headerlink" title="Lab2：Raft"></a>Lab2：Raft</h1><p><img src="https://cdn.jsdelivr.net/gh/mujiubai/piclib@main/picgo/image-20230426174946043.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/mujiubai/piclib@main/picgo/image-20230426174922607.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/mujiubai/piclib@main/picgo/image-20230428103956852.png"></p>
<p>bug</p>
<ul>
<li>当kv上层检测到需要发送Snapshot时，调用Snapshot函数，但此时raft底层从主raft收到安装镜像调用，将log进行修改，此时如果不进行log边界检查就会发生错误。</li>
<li>踩了一个坑，添加日志消息rpc的args中的entry需要进行深拷贝，否则可能因为log被修改从而导致args.entry发生改变。<ul>
<li>折腾了好久才发现这问题，其他rpc没进行深拷贝主要是因为其切片不会被改变，导致形成了思维定势。</li>
</ul>
</li>
</ul>
<h2 id="Label2A和Label2B"><a href="#Label2A和Label2B" class="headerlink" title="Label2A和Label2B"></a>Label2A和Label2B</h2><p>由于2A中的选举和2B中的日志复制有一部分相关，所以一起，但也可单独做2A，只是做2B的时候还需要修改2A代码</p>
<h3 id="任务描述-1"><a href="#任务描述-1" class="headerlink" title="任务描述"></a><strong>任务描述</strong></h3><p>实现分布式选举及分布式日志复制</p>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><p>raft结构体如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Raft <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	mu        sync<span class="token punctuation">.</span>Mutex          <span class="token comment">// Lock to protect shared access to this peer's state</span>
	peers     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd <span class="token comment">// RPC end points of all peers</span>
	persister <span class="token operator">*</span>Persister          <span class="token comment">// Object to hold this peer's persisted state</span>
	me        <span class="token builtin">int</span>                 <span class="token comment">// this peer's index into peers[]</span>
	dead      <span class="token builtin">int32</span>               <span class="token comment">// set by Kill()</span>
	
	applyCh <span class="token operator">*</span><span class="token keyword">chan</span> ApplyMsg <span class="token comment">//通过此通道提交日志和snapshot</span>

	<span class="token comment">//persistent state</span>
	currentTerm <span class="token builtin">int</span>     <span class="token comment">//当前term</span>
	votedFor    <span class="token builtin">int</span>     <span class="token comment">//当前投票给谁</span>
	log         <span class="token punctuation">[</span><span class="token punctuation">]</span>Entry <span class="token comment">//日志信息</span>

	<span class="token comment">//Volatile state</span>
	state        <span class="token builtin">int</span>   <span class="token comment">//当前raft的状态：follower、candidate、leader之一</span>
	lastRecTime  <span class="token builtin">int64</span> <span class="token comment">//当前raft最后一次收到消息时间，毫秒时间戳</span>
	commitIndex  <span class="token builtin">int</span>   <span class="token comment">//当前日志待提交的序号</span>
	lastApplied  <span class="token builtin">int</span>   <span class="token comment">//已提交日志的序号</span>
	lastLogIndex <span class="token builtin">int</span>   <span class="token comment">//最后一个日志序号</span>

	<span class="token comment">//Reinitialized after election</span>
	nextIndex  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token comment">//所有raft的下一个要发送日志的位置</span>
	matchIndex <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token comment">//和其他raft成功匹配的日志位置</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在结构体中添加了lastRecTime来记录最后一次收到消息时间，来实现超时选举。添加state来记录当时状态，lastLogIndex来记录最后一个日志位置。</p>
<p>创建raft时，commitIndex、lastApplied、lastLogIndex都初始化为1，votedFor&#x3D;-1，currentTerm&#x3D;0。为了lastApplied和commitIndex等使用方便，log初始化时添加了一个日志，使得不用每次访问log添加偏移。</p>
<p><strong>分布式选举</strong>：为每个raft创建一个定时器，当超过时间阈值进行选举，当收到日志消息或心跳时都会对lastRecTime进行更新</p>
<p><strong>日志复制</strong>：将心跳信息和发送日志合并为一个函数，心跳信息只是日志为空。通过检测日志是否匹配来更新nextIndex，从而更快完成日志复制。</p>
<p>主要有两个RPC方法，即：RequestVote（用于投票）和AppendEntries（用于接受心跳、添加日志等消息）</p>
<p>相应的，主要也是在三个函数中对这两个rpc方法进行调用：</p>
<ul>
<li>startElect（调用RequestVote进行选举）</li>
<li>syncAllEntries（调用AppendEntries用于添加同步日志）</li>
<li>sendAllHeartBeat（调用AppendEntries发送心跳）</li>
</ul>
<p>以下进行分别介绍这5个函数，其他方法如start等都较为简单</p>
<h4 id="RequestVote"><a href="#RequestVote" class="headerlink" title="RequestVote"></a>RequestVote</h4><p>request和reply结构体如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> RequestVoteArgs <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	Term         <span class="token builtin">int</span> <span class="token comment">//rpc发起者的term</span>
	CandidateId  <span class="token builtin">int</span> <span class="token comment">//rpc发起者的序号</span>
	LastLogIndex <span class="token builtin">int</span> <span class="token comment">//rpc发起者的最后一个日志的序号</span>
	LastLogTerm  <span class="token builtin">int</span> <span class="token comment">//rpc发起者的最后一个日志的term</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">type</span> RequestVoteReply <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	Term        <span class="token builtin">int</span> <span class="token comment">//被调用者的当前term</span>
	VoteGranted <span class="token builtin">bool</span> <span class="token comment">//被调用者是否同意投票给调用者</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此函数主要用于判断是否接受投票，其主要判断条件如下：</p>
<ul>
<li>如果请求方的term小于当前term，拒绝投票</li>
<li>在请求方的term不小于当前term的情况下，如果当前未投票，则比较日志谁最新。日志最新比较规则是最大term大者最新，若term相等，则日志长度越长者越新</li>
</ul>
<p>因此，此函数里面主要的实现逻辑就是上述条件。注意，如果args的term大于当前term，则必须更改当前raft的状态为follower并更新term，且将votedFor置为-1。</p>
<p>为了避免重复选举，每接收到一个vote都会对最后接受时间lastRecTime进行更新</p>
<h4 id="startElect"><a href="#startElect" class="headerlink" title="startElect"></a>startElect</h4><p>当每个raft最后一次收到消息时间超过阈值，则调用此函数进行新一轮选举。逻辑如下：</p>
<ul>
<li>首先将state置为candidate，votedFor设置自己，且将currentTerm+1</li>
<li>然后对除自己之外的raft发送投票请求<ul>
<li>当同意投票数量大于一半时（自己也算一票），则当前raft变为leader（注意，需要先判断此时currentTerm是否等于函数开始时的term，这是为了防止发起投票时，有其他raft发起新的投票）。由于超过半数就变为leader，为了防止多次变为leader，需当前状态为candidate才变为leader</li>
<li>如果收到拒绝投票，则判断reply的term是否大于当前term，若大于则更新当前term且将状态更改为follower</li>
</ul>
</li>
</ul>
<h4 id="AppendEntries"><a href="#AppendEntries" class="headerlink" title="AppendEntries"></a>AppendEntries</h4><p>request和reply结构体如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> RequestAppendArgs <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	Term         <span class="token builtin">int</span>     <span class="token comment">//发起者当前term</span>
	LeaderId     <span class="token builtin">int</span>     <span class="token comment">//发起者id</span>
	PrevLogIndex <span class="token builtin">int</span>     <span class="token comment">//当前要添加日志的前一个日志位置</span>
	PrevLogTerm  <span class="token builtin">int</span>     <span class="token comment">//当前要添加日志的前一个日志的term</span>
	Entries      <span class="token punctuation">[</span><span class="token punctuation">]</span>Entry <span class="token comment">//要添加的日志</span>
	LeaderCommit <span class="token builtin">int</span>     <span class="token comment">//发起者的commit大小，主要用于接受者提交日志</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> RequestAppendReply <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	Term       <span class="token builtin">int</span>    <span class="token comment">//接收方当前term</span>
	Success    <span class="token builtin">bool</span>   <span class="token comment">//是否成功添加日志</span>
	FailReason <span class="token builtin">string</span> <span class="token comment">//添加失败的原因，有点多余这参数，</span>
	UpdateNext <span class="token builtin">int</span>    <span class="token comment">//添加失败，即日志冲突时，需要将leader的nextIndex更新为UpdateNext</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此函数主要用于添加日志和接收心跳（心跳就是一个日志为空），其主要逻辑如下：</p>
<ul>
<li>如果args.term&lt;当前term，则拒绝添加日志，返回false</li>
<li>如果日志为空，则此消息时日志，对lastRecTime进行更新，且根据心跳消息中的LeaderCommit提交此raft的日志。</li>
<li>在上述两都不满足情况下，则说明此次请求是一个正常添加日志请求<ul>
<li>首先需要判断args.PrevLogIndex是否大于rf.lastLogIndex，大于则说明当前日志长度不够则返回false，且将reply.UpdateNext&#x3D;rf.lastLogIndex（注意，lastLogIndex可能为0，因此当其为0时需要将UpdateNext置为1，因为nextIndex最小为1）</li>
<li>args.PrevLogIndex小于等于rf.lastLogIndex，则需要判断rf.log[args.PrevLogIndex].Term 是否等于 args.PrevLogTerm，如果不等则说明日志不匹配，则返回false，且将UpdateNext更新为args.PrevLogIndex<ul>
<li>2C中如果只将UpdateNext更新为args.PrevLogIndex则会无法通过，需要优化。其优化规则是在当前日志中找到第一个日志term为rf.log[args.PrevLogIndex].Term的日志，这样就可以使得同一个term内的日志只退回一次。</li>
</ul>
</li>
<li>如果需添加日志的前一个日志不冲突，则比较需添加日志是否与当前日志冲突，若冲突则更改。不冲突，则添加。在添加日志后同样需要检查LeaderCommit，来更新当前的commit并提交日志。</li>
</ul>
</li>
</ul>
<h4 id="sendAllHeartBeat"><a href="#sendAllHeartBeat" class="headerlink" title="sendAllHeartBeat"></a>sendAllHeartBeat</h4><p>主要用于发送心跳信息，使用time.sleep每150ms发送一次，逻辑如下：</p>
<ul>
<li>每次发送前都需要判断当前状态是否为leader，如果不是则结束</li>
<li>向除自己外的raft发送心跳，LeaderCommit应该设置为min(rf.lastApplied, rf.matchIndex[idx])，如果reply.Term &gt; rf.currentTerm，则更新term并将状态置为follower。</li>
<li>注意，为了避免leader自己超时，每次发送心跳时也需要更新自己的lastRecTime</li>
</ul>
<blockquote>
<p>LeaderCommit没有按论文中的Fig2设置为commitIndex，这是为了避免日志还未同步完成就通过心跳消息发送了commit，此时日志可能还是错误的，就会导致错误日志被提交。当时这个折腾了老久。。。</p>
</blockquote>
<h4 id="syncAllEntries"><a href="#syncAllEntries" class="headerlink" title="syncAllEntries"></a>syncAllEntries</h4><p>此函数用于向其他raft同步日志，包括第一次成为leader时同步日志和有新日志时进行同步。逻辑如下：</p>
<ul>
<li>此函数为除自己为的raft都创建一个线程，线程一直运行，只有当term发生改变（又一次被选为leader）和不再为leader时才推出线程。</li>
<li>判断是否需要发送日志是通过比较lastLogIndex和rf.nextIndex[i]，如果lastLogIndex大于等于rf.nextIndex[i]则说明需要发送日志。<ul>
<li>如果reply为success，则需要将nextIndex更新为lastLogIndex + 1，matchIndex更新为lastLogIndex</li>
<li>如果reply失败：<ul>
<li>若由于第一次同步等原因日志不匹配导致失败，此时需要对nextIndex进行更新为UpdateNext</li>
<li>若由于此term小于被请求的term，则更改term、状态等并退出线程。</li>
</ul>
</li>
</ul>
</li>
<li>每次同步完日志后，需要遍历日志，找到序号最小且其被超过一半的raft提交的日志（即大于matchIndex超过一半），将commitIndex更新为此日志位置。<strong>注意</strong>，为了避免Fig8错误，若找到日志的term不等于当前term，则不更新commitIndex。<ul>
<li>还有一个更简单的方法，即通过找matchIndex的中位数，但尝试了下，有些测试有问题，还没解决。</li>
</ul>
</li>
<li>注意在此线程中没进入临界区都需要判断是否为leader或term是否发生变化。</li>
</ul>
<h2 id="Label2C"><a href="#Label2C" class="headerlink" title="Label2C"></a>Label2C</h2><p>主要实现persist函数和readPersist，其是对currentTerm、votedFor、log进行序列化保存和反序列化读取（把state也保存了。。）。根据example来写就行，注意readPersist中读取数据后，需要更新lastLogIndex值。</p>
<p>只会在创建raft时调用readPersist。按理说只要上述需要保存的三个变量发生变化就调用persist函数，但为了效率，只有当log和currentTerm发生变化时调用，即start函数、RequestVote和AppendEntries函数中调用</p>
<p>为了通过2C测试，需要对nextIndex更新做优化，否则可能无法通过。</p>
<h2 id="Label2D"><a href="#Label2D" class="headerlink" title="Label2D"></a>Label2D</h2><p>还有缺陷，将snapcommon中的iter减小后能通过lab2D，主要原因是发送同步消息时如果网络不通会很久才超时，有的要等5秒以上（网络其实早已经恢复，但还是很久才超时），从而导致每个iter处理时间很长（实验设计中同步消息是一个协程在做）</p>
<p>实现：</p>
<ul>
<li>此实验raft结构体添加了lastIncludedTerm和lastIncludedIndex，并需要将其持久化，且访问log需要带上lastIncludedIndex偏移。</li>
<li>修改persist函数，对snapshot也进行持久化。readPersist函数也需要读取snapshot。注意！提交ApplyMsg消息时不能持有锁，因为提交一定数量消息后会进行快照，此时调用Snapshot函数，而Snapshot函数中会申请锁，从而导致死锁。解决办法是创建一个协程来提交ApplyMsg消息。</li>
<li>实现Snapshot函数：此函数根据已经有的快照来修剪log，需同时修改lastIncludedTerm、lastIncludedIndex、commitIndex、lastApplied，且需要持久化。</li>
<li>实现InstallSnapshot函数：此函数对发送来得snapshot进行安装，安装成功后需要修改参数等，且需提交带snapshot的ApplyMsg</li>
<li>修改syncAllEntries函数：当nextIndex&lt;&#x3D;lastIncludedIndex时调用InstallSnapshot函数，需要对reply进行处理，如果term大于currentTerm则结束同步协程</li>
</ul>
<p>后续可做工作：</p>
<ul>
<li>发送日志消息时设置超时时间，如果超时则重发（已简单尝试，但会出错，考虑加上时间来排除重复请求）</li>
<li>合并发送日志函数和心跳函数。</li>
</ul>
<h1 id="Lab3：Kvraft"><a href="#Lab3：Kvraft" class="headerlink" title="Lab3：Kvraft"></a>Lab3：Kvraft</h1><p>整体逻辑：</p>
<ul>
<li>客户端不断轮询服务器知道请求成功</li>
<li>服务端使用一个线程来处理所有对数据的操作</li>
</ul>
<p>客户端：主要实现Get和PutAppend逻辑都差不多，都是先生成请求，不断向服务器发送请求知道请求成功，由于不知道leader，因此每次请求不成功就更改服务器id</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
	ck<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ck<span class="token punctuation">.</span>requestId<span class="token operator">++</span>
	ck<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	serverId <span class="token operator">:=</span> ck<span class="token punctuation">.</span>leaderId
	args <span class="token operator">:=</span> GetArgs<span class="token punctuation">&#123;</span>key<span class="token punctuation">,</span> ck<span class="token punctuation">.</span>me<span class="token punctuation">,</span> ck<span class="token punctuation">.</span>requestId<span class="token punctuation">&#125;</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ck[%v] send Get rpc..., args=%v"</span><span class="token punctuation">,</span> ck<span class="token punctuation">.</span>me<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		reply <span class="token operator">:=</span> GetReply<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
		ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>serverId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer.Get"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ok<span class="token punctuation">)</span> <span class="token operator">||</span> reply<span class="token punctuation">.</span>Err <span class="token operator">==</span> ErrWrongLeader <span class="token punctuation">&#123;</span>
			serverId <span class="token operator">=</span> <span class="token punctuation">(</span>serverId <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>ck<span class="token punctuation">.</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> reply<span class="token punctuation">.</span>Err <span class="token operator">==</span> ErrNoKey <span class="token punctuation">&#123;</span>
			ck<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			ck<span class="token punctuation">.</span>leaderId <span class="token operator">=</span> serverId
			ck<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ck[%v] get no key"</span><span class="token punctuation">,</span> ck<span class="token punctuation">.</span>me<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> reply<span class="token punctuation">.</span>Err <span class="token operator">==</span> OK <span class="token punctuation">&#123;</span>
			ck<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			ck<span class="token punctuation">.</span>leaderId <span class="token operator">=</span> serverId
			ck<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"ck[%v] success get value=%v, args=%v"</span><span class="token punctuation">,</span> ck<span class="token punctuation">.</span>me<span class="token punctuation">,</span> reply<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
			<span class="token keyword">return</span> reply<span class="token punctuation">.</span>Value
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token string">""</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>服务端：主要实现对Get和PutAppend rpc的响应函数，及对raft底层提交的日志进行处理applyLoop。主要使用三个哈希表来记录状态：kvdb（记录数据库）、  clientLastReq（每个客户端记录的最后一个请求），applyWaitCh（记录每个请求对应的通道）。</p>
<ul>
<li>Get函数中，先使用start函数，根据返回值判断此kv是否为leader，如果是leader则需要创建一个通道用来等待服务处理完成的结果</li>
<li>applyLoop函数中，根据底层raft提交的日志消息不断处理，如果是snapshot日志则需要根据快照恢复状态，如果kv.maxraftstate-kv.rf.GetRaftStateSize()小于一定阈值则说明需要进行快照了。如果是普通操作，则先判断其操作ID是否重复，如果重复则不根据当前日志对数据库进行操作，否则进行操作并在哈希表中记录</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>args <span class="token operator">*</span>GetArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>GetReply<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// Your code here.</span>
	<span class="token keyword">if</span> kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"kv[%v] is killed, return ErrWrongLeader"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	op <span class="token operator">:=</span> Op<span class="token punctuation">&#123;</span>GetOp<span class="token punctuation">,</span> args<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span> args<span class="token punctuation">.</span>RequestId<span class="token punctuation">&#125;</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	index<span class="token punctuation">,</span> term<span class="token punctuation">,</span> isLeader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span>
	<span class="token keyword">if</span> term <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrNoKey
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>isLeader <span class="token punctuation">&#123;</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token comment">// DPrintf("kv[%v] is not a leader, return ErrWrongLeader", kv.me)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"kv[%v] start deal get, op=%v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op<span class="token punctuation">)</span>

	curCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> applyRes<span class="token punctuation">)</span>
	command <span class="token operator">:=</span> commandEntry<span class="token punctuation">&#123;</span>op<span class="token punctuation">,</span> curCh<span class="token punctuation">&#125;</span>
	kv<span class="token punctuation">.</span>applyWaitCh<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> command
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> res <span class="token operator">:=</span> <span class="token operator">&lt;-</span>curCh<span class="token punctuation">:</span>
			reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> res<span class="token punctuation">.</span>Err
			reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> res<span class="token punctuation">.</span>Value
			<span class="token keyword">if</span> res<span class="token punctuation">.</span>Err <span class="token operator">==</span> OK <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> res<span class="token punctuation">.</span>Value <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
					res<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrNoKey
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>DealTimeOut<span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">&lt;-</span>curCh <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//需要接受处理结果，否则applyloop会死等</span>
			reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"kv[%v] timeout, return ErrWrongLeader"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">//当kv crash时</span>
	<span class="token keyword">if</span> kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>args <span class="token operator">*</span>GetArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>GetReply<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// Your code here.</span>
	<span class="token keyword">if</span> kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"kv[%v] is killed, return ErrWrongLeader"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	op <span class="token operator">:=</span> Op<span class="token punctuation">&#123;</span>GetOp<span class="token punctuation">,</span> args<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span> args<span class="token punctuation">.</span>RequestId<span class="token punctuation">&#125;</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	index<span class="token punctuation">,</span> term<span class="token punctuation">,</span> isLeader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span>
	<span class="token keyword">if</span> term <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrNoKey
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>isLeader <span class="token punctuation">&#123;</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token comment">// DPrintf("kv[%v] is not a leader, return ErrWrongLeader", kv.me)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"kv[%v] start deal get, op=%v"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> op<span class="token punctuation">)</span>

	curCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> applyRes<span class="token punctuation">)</span>
	command <span class="token operator">:=</span> commandEntry<span class="token punctuation">&#123;</span>op<span class="token punctuation">,</span> curCh<span class="token punctuation">&#125;</span>
	kv<span class="token punctuation">.</span>applyWaitCh<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> command
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token operator">!</span>kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> res <span class="token operator">:=</span> <span class="token operator">&lt;-</span>curCh<span class="token punctuation">:</span>
			reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> res<span class="token punctuation">.</span>Err
			reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> res<span class="token punctuation">.</span>Value
			<span class="token keyword">if</span> res<span class="token punctuation">.</span>Err <span class="token operator">==</span> OK <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> res<span class="token punctuation">.</span>Value <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
					res<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrNoKey
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>DealTimeOut<span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">&lt;-</span>curCh <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//需要接受处理结果，否则applyloop会死等</span>
			reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"kv[%v] timeout, return ErrWrongLeader"</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>me<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">//当kv crash时</span>
	<span class="token keyword">if</span> kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<blockquote>
<p>遇到问题</p>
<ul>
<li>completion after heal (3A) 无法通过<ul>
<li>将请求响应等待超时时间设置的过大，导致没有超时返回ERRWrongLeader, 就不会重新发送请求将值设置为15，导致无法通过</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="Lab4：Sharded-KV-Service"><a href="#Lab4：Sharded-KV-Service" class="headerlink" title="Lab4：Sharded KV Service"></a>Lab4：Sharded KV Service</h1><h2 id="Label4A"><a href="#Label4A" class="headerlink" title="Label4A"></a>Label4A</h2><p>此实验需要实现一个高容错的配置管理中心，因此使用raft作为底层同步协议，使用多个服务器作为一个group，从而提供配置服务。</p>
<p>整体逻辑：</p>
<ul>
<li>每进行一次配置变动就形成新版本配置，且以前配置都需要在configs中进行保存</li>
<li>由于多个服务器需要进行同步，因此配置变动操作需要先提交给raft底层，然后根据raft apply的日志不断进行操作，因此需要有一个函数applyLoop不断循环处理raft提交的日志。</li>
<li>由于需要将操作提交到底层，因此需要一个结构体Op来描述各种操作及携带的数据，然后applyLoop根据日志中的Op进行相应处理。</li>
<li>在提交给raft后，需要等待操作完成，这里使用通道进行等待，没个操作对应一个通道，当applyLoop处理完一个操作就在对应通道发送信号。因此使用一个哈希表applyWaitCh来存储日志序号（每提交一个操作都会有唯一的日志序号）对应的通道。</li>
<li>当处理Join、Move、Leave操作后，需要对shard配置进行重新分配使得配置均衡。一个简单的算法就是不断找出当前分片数最多的服务器A和分片数最少得服务器B，然后将最后一个分片分配给分片数最少得服务器（注意这里不要用map存储，因为map取第一个值是随机的，从而导致多个服务器状态不同），知道分片最多服务器和分片最少服务器分片数量最多相差1。</li>
<li>和kvraft一样，为了过滤重复请求，使用一个哈希表 clientLastReq来记录每个客户端已被处理的最大请求和对应请求结果（用于get）</li>
<li>这里没有提供persister，因此无需进行snapshot处理</li>
</ul>
<p>各结构体如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> ShardCtrler <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	mu      sync<span class="token punctuation">.</span>Mutex
	me      <span class="token builtin">int</span>
	rf      <span class="token operator">*</span>raft<span class="token punctuation">.</span>Raft
	applyCh <span class="token keyword">chan</span> raft<span class="token punctuation">.</span>ApplyMsg

	<span class="token comment">// Your data here.</span>
	clientLastReq <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>applyRes  <span class="token comment">//记录每个客户端已被处理的最大请求和对应请求结果，用于过滤重复请求</span>
	applyWaitCh   <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token keyword">chan</span> applyRes <span class="token comment">//存储日志序号（每提交一个操作都会有唯一的日志序号）对应的通道</span>

	lastApply <span class="token builtin">int</span> <span class="token comment">//最近被处理的日志序号，</span>

	configs   <span class="token punctuation">[</span><span class="token punctuation">]</span>Config <span class="token comment">// indexed by config num  存储当前所有配置</span>
	curConfId <span class="token builtin">int</span> <span class="token comment">//最后一个配置序号</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> applyRes <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	Err   Err
	reqId <span class="token builtin">int</span>
	Value Config
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> Op <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// Your data here.</span>
	Operation <span class="token builtin">string</span>
	ClientID  <span class="token builtin">int64</span>
	RequestId <span class="token builtin">int</span>
	Servers   <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">//JoinOp</span>
	GIDs      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>            <span class="token comment">//LeaveOp</span>
	Shard     <span class="token builtin">int</span>              <span class="token comment">//MoveOp</span>
	GID       <span class="token builtin">int</span>              <span class="token comment">//MoveOp</span>
	Num       <span class="token builtin">int</span>              <span class="token comment">//QueryOp</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="Label4B"><a href="#Label4B" class="headerlink" title="Label4B"></a>Label4B</h2><p>此部分需要实现一个分片kv服务，有多组group，每组group的多个服务器使用同一raft来同步数据，每组group存储不同分片，客户端通过哈希函数可确定需要访问哪个分片。由于配置会发生变化，因此还需要向其他group发送或接收分片数据。</p>
<p>主要逻辑：</p>
<ul>
<li>首先，和4a一样，客户端的各种操作需要向底层raft提交来进行操作，然后使用函数applyLoop不断循环处理raft提交的日志。</li>
<li>由于配置不断发生改变，因此使用一个线程detecConfLoop不断获取新配置。注意，只有在当前配置curConf和上一个配置preConf之间的数据已经同步完成才能获取新配置，且只获取比当前版本号大1的新配置。同步数据是否完成包含两个部分：<ul>
<li>发送数据是否完成：将不属于当前配置的切片发送给相应服务器，当未发送完成时需要向其他服务器发送，每当发送成功一个切片后需要向raft提交删除相应切片数据日志</li>
<li>接受数据是否完成：属于当前配置的切片是否已经接收完毕，每当接收一个切片数据就向raft提交更新切片数据日志。</li>
<li>注意，数据的更新和删除必须通过raft，才能使得整个group的状态一致。</li>
</ul>
</li>
<li></li>
</ul>
<p>bug1</p>
<ul>
<li>restart错误，未成功安装底层提交的镜像，因为判断是否安装的条件写反了</li>
<li>append重复提交应当成功处理</li>
<li>同一更新配置命令可能会提交两次（即使通道一直等待处理结果，也可能因为机器重启导致提交相同的配置两次）。当两次配置都被应用，导致value值被清空。解决方法：重复检测，如果新配置不比当前配置大则不配置。</li>
<li>底层raft有点问题，重新启动时需要提交一条空日志后raft才会向上层提交日志</li>
<li>记录客户端请求id时需要记录请求结果，当检测到重复请求时，返回上次请求结果，特别是GET请求。</li>
<li>需要特别处理shard配置为0时，此时将服务端设置为自己向自己发送消息。</li>
<li>发送更新shard消息时，由于网络不稳定，有时一直无法得到结果（call不通，不返回false，也没有reply）。解决方法：每次都随机在GRoup挑选一个进行发送，使得不会因为一个机器网络问题而一直不对后面机器进行尝试。</li>
<li>因为网络问题，shard数据已经发送成功，但返回结果时出现问题，且接收端应用了新配置，导致后面不断发送shard分片数据时，返回错误结果。解决方法：条件判定出错了，应该先判断是否为旧分片数据（使用confignum判断），然后再判断当前配置是否允许接受改分片</li>
<li>服务器重启后，日志还未重放完，此时发送shard数据从而导致数据缺失（一些操作已经返回操作成功结果，导致客户端不会在新服务器请求）。解决方法：设置一个是否重放完成标志，并在创建服务器后插入一条特殊日志，当应用到特殊日志时，就将标志设为true，在检测配置循环中，每次都判断标志。</li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">mujiubai</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://mujiubai.github.io/2023/02/15/%E9%A1%B9%E7%9B%AE/Mit-6.824/">https://mujiubai.github.io/2023/02/15/%E9%A1%B9%E7%9B%AE/Mit-6.824/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">mujiubai</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/">
                                    <span class="chip bg-color">分布式存储</span>
                                </a>
                            
                                <a href="/tags/Go/">
                                    <span class="chip bg-color">Go</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/02/15/c++/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5_C_Linux/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/16.jpg" class="responsive-img" alt="多线程和线程同步-C-Linux">
                        
                        <span class="card-title">多线程和线程同步-C-Linux</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-02-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/C/" class="post-category">
                                    C++
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/C/">
                        <span class="chip bg-color">C++</span>
                    </a>
                    
                    <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">
                        <span class="chip bg-color">多线程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/02/15/%E9%A1%B9%E7%9B%AE/mprpc-%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1%E7%BD%91%E7%BB%9C%E6%A1%86%E6%9E%B6/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="mprpc-分布式通信网络框架">
                        
                        <span class="card-title">mprpc-分布式通信网络框架</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-02-15
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%A1%B9%E7%9B%AE/" class="post-category">
                                    项目
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/C/">
                        <span class="chip bg-color">C++</span>
                    </a>
                    
                    <a href="/tags/RPC/">
                        <span class="chip bg-color">RPC</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <a href="/about" target="_blank">mujiubai</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">317.1k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/mujiubai" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1057378931@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1057378931" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1057378931" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/star.js"><\/script>');
            }
        </script>
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
